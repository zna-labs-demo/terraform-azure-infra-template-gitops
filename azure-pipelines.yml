# =============================================================================
# Azure DevOps Pipeline - Infrastructure Deployment
# =============================================================================
# This single pipeline handles everything:
#   1. Validates terraform configuration
#   2. Creates/updates TFC workspaces (vending)
#   3. Deploys to enabled environments
#
# To enable an environment: edit environments.yaml, set enabled: true, merge PR.
# =============================================================================

trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: TF_VERSION
    value: '1.9.0'
  - name: TF_IN_AUTOMATION
    value: 'true'

stages:
  # ===========================================================================
  # Stage 1: Quality Gates - Validate Configuration
  # ===========================================================================
  - stage: QualityGates
    displayName: 'Quality Gates'
    jobs:
      - job: Validate
        displayName: 'Format & Validate'
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: terraform fmt -check -recursive -diff
            displayName: 'Terraform Format'

          - script: |
              terraform init -backend=false
              terraform validate
            displayName: 'Terraform Validate'

          # Read environments.yaml and set output variables
          - bash: |
              set -x  # Debug mode

              # Parse YAML with grep (simpler than yq)
              DEV_ENABLED=$(grep -A1 "dev:" environments.yaml | grep "enabled:" | awk '{print $2}')
              QA_ENABLED=$(grep -A1 "qa:" environments.yaml | grep "enabled:" | awk '{print $2}')
              TEST_ENABLED=$(grep -A1 "test:" environments.yaml | grep "enabled:" | awk '{print $2}')
              PROD_ENABLED=$(grep -A1 "prod:" environments.yaml | grep "enabled:" | awk '{print $2}')

              echo "DEV_ENABLED: [$DEV_ENABLED]"
              echo "QA_ENABLED: [$QA_ENABLED]"
              echo "TEST_ENABLED: [$TEST_ENABLED]"
              echo "PROD_ENABLED: [$PROD_ENABLED]"

              # Set pipeline variables for use in conditions
              echo "##vso[task.setvariable variable=DEV_ENABLED;isOutput=true]$DEV_ENABLED"
              echo "##vso[task.setvariable variable=QA_ENABLED;isOutput=true]$QA_ENABLED"
              echo "##vso[task.setvariable variable=TEST_ENABLED;isOutput=true]$TEST_ENABLED"
              echo "##vso[task.setvariable variable=PROD_ENABLED;isOutput=true]$PROD_ENABLED"

              echo "Variables set successfully"
            name: ReadConfig
            displayName: 'Read Environment Config'

  # ===========================================================================
  # Stage 2: Vending - Create/Update TFC Workspaces
  # ===========================================================================
  - stage: Vending
    displayName: 'Vending (TFC Workspaces)'
    dependsOn: QualityGates
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    variables:
      DEV_ENABLED: $[ stageDependencies.QualityGates.Validate.outputs['ReadConfig.DEV_ENABLED'] ]
      QA_ENABLED: $[ stageDependencies.QualityGates.Validate.outputs['ReadConfig.QA_ENABLED'] ]
      TEST_ENABLED: $[ stageDependencies.QualityGates.Validate.outputs['ReadConfig.TEST_ENABLED'] ]
      PROD_ENABLED: $[ stageDependencies.QualityGates.Validate.outputs['ReadConfig.PROD_ENABLED'] ]
    jobs:
      - job: CreateWorkspaces
        displayName: 'Create TFC Workspaces'
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: $(TF_VERSION)

          - bash: |
              # Extract APP_ID from repo name
              REPO_NAME="$(Build.Repository.Name)"
              APP_ID=$(echo "$REPO_NAME" | rev | cut -d'/' -f1 | rev | sed 's/^terraform-azure-infra-//')
              echo "##vso[task.setvariable variable=APP_ID]$APP_ID"
              echo "APP_ID: $APP_ID"
            displayName: 'Extract App ID'

          - bash: |
              mkdir -p ~/.terraform.d
              echo "{\"credentials\":{\"app.terraform.io\":{\"token\":\"$TFC_TOKEN\"}}}" > ~/.terraform.d/credentials.tfrc.json
            displayName: 'Configure TFC'
            env:
              TFC_TOKEN: $(TFC_TOKEN)

          - bash: |
              echo "=============================================="
              echo "Vending workspace (variables set by central vending)"
              echo "=============================================="

              cd .vending
              terraform init
              terraform apply -auto-approve

              # Pass through enabled flags as output variables for deploy stages
              echo "##vso[task.setvariable variable=DEV_ENABLED;isOutput=true]$(DEV_ENABLED)"
              echo "##vso[task.setvariable variable=QA_ENABLED;isOutput=true]$(QA_ENABLED)"
              echo "##vso[task.setvariable variable=TEST_ENABLED;isOutput=true]$(TEST_ENABLED)"
              echo "##vso[task.setvariable variable=PROD_ENABLED;isOutput=true]$(PROD_ENABLED)"
            name: ApplyVending
            displayName: 'Apply Vending'

  # ===========================================================================
  # Stage 3: Deploy DEV (auto-approve)
  # ===========================================================================
  - stage: DeployDev
    displayName: 'Deploy DEV'
    dependsOn: Vending
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(stageDependencies.Vending.CreateWorkspaces.outputs['ApplyVending.DEV_ENABLED'], 'true'))
    jobs:
      - job: Dev
        displayName: 'Apply DEV'
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: $(TF_VERSION)

          - bash: |
              REPO_NAME="$(Build.Repository.Name)"
              APP_ID=$(echo "$REPO_NAME" | rev | cut -d'/' -f1 | rev | sed 's/^terraform-azure-infra-//')
              echo "##vso[task.setvariable variable=APP_ID]$APP_ID"
            displayName: 'Extract App ID'

          - bash: |
              mkdir -p ~/.terraform.d
              echo "{\"credentials\":{\"app.terraform.io\":{\"token\":\"$TFC_TOKEN\"}}}" > ~/.terraform.d/credentials.tfrc.json
            displayName: 'Configure TFC'
            env:
              TFC_TOKEN: $(TFC_TOKEN)

          - bash: |
              echo "Deploying to workspace: $(APP_ID)n1d01"
              export TF_WORKSPACE="$(APP_ID)n1d01"
              terraform init
              terraform apply -auto-approve
            displayName: 'Apply DEV'

  # ===========================================================================
  # Stage 4: Deploy TEST (requires approval)
  # ===========================================================================
  - stage: DeployTest
    displayName: 'Deploy TEST'
    dependsOn:
      - DeployDev
      - Vending
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(stageDependencies.Vending.CreateWorkspaces.outputs['ApplyVending.TEST_ENABLED'], 'true'))
    jobs:
      - deployment: Test
        displayName: 'Apply TEST'
        environment: 'Test'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@1
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - bash: |
                    REPO_NAME="$(Build.Repository.Name)"
                    APP_ID=$(echo "$REPO_NAME" | rev | cut -d'/' -f1 | rev | sed 's/^terraform-azure-infra-//')
                    echo "##vso[task.setvariable variable=APP_ID]$APP_ID"
                  displayName: 'Extract App ID'

                - bash: |
                    mkdir -p ~/.terraform.d
                    echo "{\"credentials\":{\"app.terraform.io\":{\"token\":\"$TFC_TOKEN\"}}}" > ~/.terraform.d/credentials.tfrc.json
                  displayName: 'Configure TFC'
                  env:
                    TFC_TOKEN: $(TFC_TOKEN)

                - bash: |
                    echo "Deploying to workspace: $(APP_ID)n1t01"
                    export TF_WORKSPACE="$(APP_ID)n1t01"
                    terraform init
                    terraform apply -auto-approve
                  displayName: 'Apply TEST'

  # ===========================================================================
  # Stage 5: Deploy QA (requires approval)
  # ===========================================================================
  - stage: DeployQa
    displayName: 'Deploy QA'
    dependsOn:
      - DeployTest
      - Vending
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(stageDependencies.Vending.CreateWorkspaces.outputs['ApplyVending.QA_ENABLED'], 'true'))
    jobs:
      - deployment: Qa
        displayName: 'Apply QA'
        environment: 'QA'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@1
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - bash: |
                    REPO_NAME="$(Build.Repository.Name)"
                    APP_ID=$(echo "$REPO_NAME" | rev | cut -d'/' -f1 | rev | sed 's/^terraform-azure-infra-//')
                    echo "##vso[task.setvariable variable=APP_ID]$APP_ID"
                  displayName: 'Extract App ID'

                - bash: |
                    mkdir -p ~/.terraform.d
                    echo "{\"credentials\":{\"app.terraform.io\":{\"token\":\"$TFC_TOKEN\"}}}" > ~/.terraform.d/credentials.tfrc.json
                  displayName: 'Configure TFC'
                  env:
                    TFC_TOKEN: $(TFC_TOKEN)

                - bash: |
                    echo "Deploying to workspace: $(APP_ID)n1q01"
                    export TF_WORKSPACE="$(APP_ID)n1q01"
                    terraform init
                    terraform apply -auto-approve
                  displayName: 'Apply QA'

  # ===========================================================================
  # Stage 6: Deploy PROD (requires approval)
  # ===========================================================================
  - stage: DeployProd
    displayName: 'Deploy PROD'
    dependsOn:
      - DeployQa
      - Vending
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(stageDependencies.Vending.CreateWorkspaces.outputs['ApplyVending.PROD_ENABLED'], 'true'))
    jobs:
      - deployment: Prod
        displayName: 'Apply PROD'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@1
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - bash: |
                    REPO_NAME="$(Build.Repository.Name)"
                    APP_ID=$(echo "$REPO_NAME" | rev | cut -d'/' -f1 | rev | sed 's/^terraform-azure-infra-//')
                    echo "##vso[task.setvariable variable=APP_ID]$APP_ID"
                  displayName: 'Extract App ID'

                - bash: |
                    mkdir -p ~/.terraform.d
                    echo "{\"credentials\":{\"app.terraform.io\":{\"token\":\"$TFC_TOKEN\"}}}" > ~/.terraform.d/credentials.tfrc.json
                  displayName: 'Configure TFC'
                  env:
                    TFC_TOKEN: $(TFC_TOKEN)

                - bash: |
                    echo "Deploying to workspace: $(APP_ID)p1p01"
                    export TF_WORKSPACE="$(APP_ID)p1p01"
                    terraform init
                    terraform apply -auto-approve
                  displayName: 'Apply PROD'
