# =============================================================================
# Azure DevOps CI/CD Pipeline for Terraform Infrastructure
# =============================================================================
# This pipeline performs:
# - Quality gates on PRs (format, validate, lint, security)
# - Progressive deployment: Dev -> QA -> Prod on main branch
# - ADO Environment approval gates for QA and Production
#
# SETUP REQUIRED:
#   1. Create ADO Environments: 'QA' and 'Production' with approval gates
#   2. Add pipeline variable: TFC_TOKEN (secret) - your Terraform Cloud token
#   3. Ensure TFC workspaces exist with appropriate tags
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - '*.md'
      - '.gitignore'

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_VERSION: '1.6.6'
  TFLINT_VERSION: 'v0.50.0'
  TF_IN_AUTOMATION: 'true'
  # Extract app_id from repo name (terraform-azure-infra-{app_id})
  APP_ID: $[ replace(variables['Build.Repository.Name'], 'terraform-azure-infra-', '') ]

stages:
  # ===========================================================================
  # Stage 1: Quality Gates (runs on all PRs and main branch pushes)
  # ===========================================================================
  - stage: QualityGates
    displayName: 'Quality Gates'
    jobs:
      - job: TerraformFormat
        displayName: 'Terraform Format Check'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              terraform fmt -check -recursive -diff
            displayName: 'Check Terraform Formatting'
            workingDirectory: $(System.DefaultWorkingDirectory)

      - job: TerraformValidate
        displayName: 'Terraform Validate'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              terraform init -backend=false
            displayName: 'Terraform Init (No Backend)'
            workingDirectory: $(System.DefaultWorkingDirectory)

          - script: |
              terraform validate
            displayName: 'Terraform Validate'
            workingDirectory: $(System.DefaultWorkingDirectory)

      - job: TFLint
        displayName: 'TFLint Analysis'
        steps:
          - script: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
            displayName: 'Install TFLint'

          - script: |
              tflint --init
              tflint --format compact
            displayName: 'Run TFLint'
            workingDirectory: $(System.DefaultWorkingDirectory)

      - job: SecurityScan
        displayName: 'Security Scan (tfsec)'
        steps:
          - script: |
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
            displayName: 'Install tfsec'

          - script: |
              tfsec . --format lovely --minimum-severity MEDIUM
            displayName: 'Run tfsec Security Scan'
            workingDirectory: $(System.DefaultWorkingDirectory)
            continueOnError: true

  # ===========================================================================
  # Stage 2: Plan (PR Only) - Shows what TFC will apply
  # ===========================================================================
  - stage: Plan
    displayName: 'Terraform Plan'
    dependsOn: QualityGates
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: TerraformPlan
        displayName: 'Generate Plan Summary'
        steps:
          - script: |
              echo "## Terraform Plan Summary" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "Terraform Cloud will generate the actual plan when this PR is merged." >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "### Quality Gate Results" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- Format: Passed" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- Validation: Passed" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- TFLint: Passed" >> $(System.DefaultWorkingDirectory)/plan-summary.md
              echo "- Security: Scanned" >> $(System.DefaultWorkingDirectory)/plan-summary.md
            displayName: 'Generate Plan Summary'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/plan-summary.md'
              artifact: 'plan-summary'
            displayName: 'Publish Plan Summary'

  # ===========================================================================
  # Stage 3: Dev Environment - Auto-deploys on push to main
  # ===========================================================================
  - stage: Dev
    displayName: 'Deploy to Dev'
    dependsOn: QualityGates
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    variables:
      WORKSPACE_NAME: $[ format('{0}n1d01-app-infra', variables['APP_ID']) ]
    jobs:
      - job: TerraformDev
        displayName: 'Terraform Dev'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - bash: |
              mkdir -p ~/.terraform.d
              cat > ~/.terraform.d/credentials.tfrc.json << EOF
              {
                "credentials": {
                  "app.terraform.io": {
                    "token": "$(TFC_TOKEN)"
                  }
                }
              }
              EOF
            displayName: 'Configure TFC Credentials'

          - bash: |
              echo "=============================================="
              echo "Deploying to DEV Environment"
              echo "App ID: $(APP_ID)"
              echo "Workspace: $(WORKSPACE_NAME)"
              echo "=============================================="
              export TF_WORKSPACE="$(WORKSPACE_NAME)"
              terraform init
            displayName: 'Terraform Init (Dev)'
            workingDirectory: $(System.DefaultWorkingDirectory)

          - bash: |
              export TF_WORKSPACE="$(WORKSPACE_NAME)"
              terraform plan \
                -var-file=environments/dev.tfvars \
                -out=tfplan-dev
            displayName: 'Terraform Plan (Dev)'
            workingDirectory: $(System.DefaultWorkingDirectory)

          - bash: |
              export TF_WORKSPACE="$(WORKSPACE_NAME)"
              terraform apply -auto-approve tfplan-dev
            displayName: 'Terraform Apply (Dev)'
            workingDirectory: $(System.DefaultWorkingDirectory)

  # ===========================================================================
  # Stage 4: QA Environment - Requires ADO Environment approval
  # ===========================================================================
  - stage: QA
    displayName: 'Deploy to QA'
    dependsOn: Dev
    condition: succeeded()
    variables:
      WORKSPACE_NAME: $[ format('{0}n1q01-app-infra', variables['APP_ID']) ]
    jobs:
      - deployment: TerraformQA
        displayName: 'Terraform QA'
        environment: 'QA'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform $(TF_VERSION)'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - bash: |
                    mkdir -p ~/.terraform.d
                    cat > ~/.terraform.d/credentials.tfrc.json << EOF
                    {
                      "credentials": {
                        "app.terraform.io": {
                          "token": "$(TFC_TOKEN)"
                        }
                      }
                    }
                    EOF
                  displayName: 'Configure TFC Credentials'

                - bash: |
                    echo "=============================================="
                    echo "Deploying to QA Environment"
                    echo "App ID: $(APP_ID)"
                    echo "Workspace: $(WORKSPACE_NAME)"
                    echo "Environment file: environments/qa.tfvars"
                    echo "=============================================="
                    export TF_WORKSPACE="$(WORKSPACE_NAME)"
                    terraform init
                  displayName: 'Terraform Init (QA)'
                  workingDirectory: $(System.DefaultWorkingDirectory)

                - bash: |
                    export TF_WORKSPACE="$(WORKSPACE_NAME)"
                    terraform plan \
                      -var-file=environments/qa.tfvars \
                      -out=tfplan-qa
                  displayName: 'Terraform Plan (QA)'
                  workingDirectory: $(System.DefaultWorkingDirectory)

                - bash: |
                    export TF_WORKSPACE="$(WORKSPACE_NAME)"
                    terraform apply -auto-approve tfplan-qa
                  displayName: 'Terraform Apply (QA)'
                  workingDirectory: $(System.DefaultWorkingDirectory)

  # ===========================================================================
  # Stage 5: Production Environment - Requires ADO Environment approval
  # ===========================================================================
  - stage: Prod
    displayName: 'Deploy to Prod'
    dependsOn: QA
    condition: succeeded()
    variables:
      WORKSPACE_NAME: $[ format('{0}p1p01-app-infra', variables['APP_ID']) ]
    jobs:
      - deployment: TerraformProd
        displayName: 'Terraform Prod'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@1
                  displayName: 'Install Terraform $(TF_VERSION)'
                  inputs:
                    terraformVersion: $(TF_VERSION)

                - bash: |
                    mkdir -p ~/.terraform.d
                    cat > ~/.terraform.d/credentials.tfrc.json << EOF
                    {
                      "credentials": {
                        "app.terraform.io": {
                          "token": "$(TFC_TOKEN)"
                        }
                      }
                    }
                    EOF
                  displayName: 'Configure TFC Credentials'

                - bash: |
                    echo "=============================================="
                    echo "Deploying to PRODUCTION Environment"
                    echo "App ID: $(APP_ID)"
                    echo "Workspace: $(WORKSPACE_NAME)"
                    echo "Environment file: environments/prod.tfvars"
                    echo "=============================================="
                    export TF_WORKSPACE="$(WORKSPACE_NAME)"
                    terraform init
                  displayName: 'Terraform Init (Prod)'
                  workingDirectory: $(System.DefaultWorkingDirectory)

                - bash: |
                    export TF_WORKSPACE="$(WORKSPACE_NAME)"
                    terraform plan \
                      -var-file=environments/prod.tfvars \
                      -out=tfplan-prod
                  displayName: 'Terraform Plan (Prod)'
                  workingDirectory: $(System.DefaultWorkingDirectory)

                - bash: |
                    export TF_WORKSPACE="$(WORKSPACE_NAME)"
                    terraform apply -auto-approve tfplan-prod
                  displayName: 'Terraform Apply (Prod)'
                  workingDirectory: $(System.DefaultWorkingDirectory)
